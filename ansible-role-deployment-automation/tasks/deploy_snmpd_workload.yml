# Deploy SNMP workload into infra cluster
---
- name: Prepare SNMP pod annotations with image digest
  vars:
    __snmpd_digest_value: "{{ snmpd_image_current_digest | default('') | string | trim }}"
    __snmpd_digest_annotation: >-
      {{
        (__snmpd_digest_value | length > 0)
        | ternary({snmpd_image_digest_annotation_key: __snmpd_digest_value}, {})
      }}
  ansible.builtin.set_fact:
    snmpd_pod_annotations: >-
      {{
        (snmpd_pod_annotations | default({}))
        | combine(__snmpd_digest_annotation, recursive=True)
      }}

- name: Check SNMP namespace presence
  ansible.builtin.command:
    cmd: >-
      kubectl --kubeconfig {{ __temp_dir.path }}/kubeconfig-infra
      get namespace {{ snmpd_namespace }}
  register: __snmpd_namespace_get
  changed_when: false
  failed_when: __snmpd_namespace_get.rc not in [0, 1]

- name: Create SNMP namespace when missing
  ansible.builtin.command:
    cmd: >-
      kubectl --kubeconfig {{ __temp_dir.path }}/kubeconfig-infra
      create namespace {{ snmpd_namespace }}
  when: __snmpd_namespace_get.rc != 0
  register: __snmpd_namespace_create
  changed_when: (__snmpd_namespace_create.stdout | default('')) is search('created')
  failed_when: __snmpd_namespace_create.rc != 0

- name: Render SNMP credential secret manifest
  ansible.builtin.template:
    src: templates/k8s/infra/snmpd/secret.yaml.j2
    dest: "{{ __temp_dir.path }}/snmpd-secret.yaml"
    mode: "0644"
  register: __snmpd_secret_manifest
  changed_when: false

- name: Apply SNMP credential secret
  ansible.builtin.command:
    cmd: >-
      kubectl --kubeconfig {{ __temp_dir.path }}/kubeconfig-infra
      apply -f {{ __snmpd_secret_manifest.dest }}
  register: __snmpd_secret_apply
  changed_when: >-
    (__snmpd_secret_apply.stdout_lines | default([])
     | select('match', ' (created|configured)$')
     | list | length) > 0
  failed_when: __snmpd_secret_apply.rc != 0

- name: Render SNMP workload manifest
  ansible.builtin.template:
    src: templates/k8s/infra/snmpd/workload.yaml.j2
    dest: "{{ __temp_dir.path }}/snmpd-workload.yaml"
    mode: "0644"
  register: __snmpd_manifest
  changed_when: false

- name: Apply SNMP workload manifest
  ansible.builtin.command:
    cmd: >-
      kubectl --kubeconfig {{ __temp_dir.path }}/kubeconfig-infra
      apply -f {{ __snmpd_manifest.dest }}
  register: __snmpd_manifest_apply
  changed_when: >-
    (__snmpd_manifest_apply.stdout_lines | default([])
     | select('match', ' (created|configured)$')
     | list | length) > 0
  failed_when: __snmpd_manifest_apply.rc != 0

- name: Restart SNMPd statefulset to pick up image updates
  ansible.builtin.command:
    cmd: >-
      kubectl --kubeconfig {{ __temp_dir.path }}/kubeconfig-infra
      rollout restart statefulset/{{ snmpd_statefulset_name }}
      --namespace {{ snmpd_namespace }}
  register: __snmpd_rollout_restart
  when: snmpd_force_rollout_restart | bool
  changed_when: (__snmpd_rollout_restart.stdout | default('')) is search('restarted')

- name: Wait for SNMPd deployment rollout
  ansible.builtin.command:
    cmd: >-
      kubectl --kubeconfig {{ __temp_dir.path }}/kubeconfig-infra
      rollout status statefulset/{{ snmpd_statefulset_name }}
      --namespace {{ snmpd_namespace }}
      --timeout=120s
  register: __snmpd_rollout
  changed_when: false
  failed_when: __snmpd_rollout.rc != 0
