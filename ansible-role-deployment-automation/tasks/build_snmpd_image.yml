# Build and import SNMP daemon container image into kind
---
- name: Ensure SNMPd container build context exists
  ansible.builtin.file:
    path: "{{ __temp_dir.path }}/snmpd-container"
    state: directory
    mode: "0755"
  changed_when: false

- name: Render SNMPd container build files
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "{{ item.mode }}"
  loop:
    - src: container/snmpd/Containerfile.j2
      dest: "{{ __temp_dir.path }}/snmpd-container/Containerfile"
      mode: "0644"
    - src: container/snmpd/snmpd.conf.j2
      dest: "{{ __temp_dir.path }}/snmpd-container/snmpd.conf.template"
      mode: "0644"
    - src: container/snmpd/container-entrypoint.sh.j2
      dest: "{{ __temp_dir.path }}/snmpd-container/container-entrypoint.sh"
      mode: "0755"
  changed_when: false

- name: Record SNMPd image references
  ansible.builtin.set_fact:
    __snmpd_image_local_ref: "{{ snmpd_image_repository }}:{{ snmpd_image_tag }}"
    __snmpd_image_registry_ref: "{{ snmpd_image_registry }}/{{ snmpd_image_repository }}:{{ snmpd_image_tag }}"
    __snmpd_image_archive_path: "{{ __temp_dir.path }}/{{ snmpd_image_archive }}"

- name: Build SNMPd container image with Podman
  containers.podman.podman_image:
    name: "{{ snmpd_image_repository }}"
    tag: "{{ snmpd_image_tag }}"
    path: "{{ __temp_dir.path }}/snmpd-container"
    build:
      file: Containerfile
      format: oci
      cache: false
    force: "{{ snmpd_force_rebuild_image | bool }}"
  register: __snmpd_image_build

- name: Inspect SNMPd image digest
  ansible.builtin.command:
    argv:
      - podman
      - image
      - inspect
      - "{{ __snmpd_image_local_ref }}"
      - --format
      - "{{ '{{.Id}}' }}"
  register: __snmpd_image_inspect
  changed_when: false
  failed_when: __snmpd_image_inspect.rc != 0

- name: Record SNMPd image digest fact
  ansible.builtin.set_fact:
    snmpd_image_current_digest: "{{ __snmpd_image_inspect.stdout | default('') | trim }}"

- name: Discover deployed SNMPd image digest annotation (if present)
  ansible.builtin.command:
    argv:
      - kubectl
      - --kubeconfig
      - "{{ __temp_dir.path }}/kubeconfig-infra"
      - get
      - statefulset
      - "{{ snmpd_statefulset_name }}"
      - --namespace
      - "{{ snmpd_namespace }}"
      - --ignore-not-found=true
      - -o
      - "jsonpath={.spec.template.metadata.annotations['{{ snmpd_image_digest_annotation_key }}']}"
  register: __snmpd_deployed_digest_cmd
  changed_when: false
  failed_when: __snmpd_deployed_digest_cmd.rc != 0

- name: Record deployed SNMPd image digest fact
  ansible.builtin.set_fact:
    snmpd_image_deployed_digest: "{{ __snmpd_deployed_digest_cmd.stdout | default('') | trim }}"

- name: Determine if SNMPd image publish is required
  ansible.builtin.set_fact:
    snmpd_image_publish_required: >-
      {{
        (snmpd_force_rebuild_image | bool)
        or ((snmpd_image_deployed_digest | default(''))
            != (snmpd_image_current_digest | default('')))
      }}

- name: Tag SNMPd image for Kind import
  ansible.builtin.command:
    argv:
      - podman
      - tag
      - "{{ __snmpd_image_local_ref }}"
      - "{{ __snmpd_image_registry_ref }}"
  register: __snmpd_image_tag_result
  when: snmpd_image_publish_required | bool
  changed_when: __snmpd_image_tag_result.rc == 0
  failed_when: __snmpd_image_tag_result.rc != 0

- name: Save SNMPd image to archive
  ansible.builtin.command:
    argv:
      - podman
      - save
      - "{{ __snmpd_image_registry_ref }}"
      - -o
      - "{{ __snmpd_image_archive_path }}"
  register: __snmpd_image_save
  changed_when: __snmpd_image_save.rc == 0
  failed_when: __snmpd_image_save.rc != 0
  when: snmpd_image_publish_required | bool

- name: Load SNMPd image archive into kind cluster
  ansible.builtin.command:
    argv:
      - kind
      - load
      - image-archive
      - "{{ __snmpd_image_archive_path }}"
      - --name
      - "{{ snmpd_kind_cluster_name }}"
  register: __snmpd_kind_load
  changed_when: __snmpd_kind_load.rc == 0
  failed_when: __snmpd_kind_load.rc != 0
  when: snmpd_image_publish_required | bool

- name: Remove SNMPd image archive
  ansible.builtin.file:
    path: "{{ __snmpd_image_archive_path }}"
    state: absent
  when: snmpd_image_cleanup_archive | bool
