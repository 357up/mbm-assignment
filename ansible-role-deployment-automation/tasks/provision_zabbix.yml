# Zabbix provisioning tasks
---
- name: Ensure zabbix-community Helm repository is configured
  kubernetes.core.helm_repository:
    name: zabbix-community
    repo_url: https://zabbix-community.github.io/helm-zabbix
    state: present
  notify:
    - update zabbix-community helm repository cache

- name: Render Zabbix Helm values file
  ansible.builtin.template:
    src: templates/helm/mgmt/zabbix-server/values.yaml.j2
    dest: "{{ __temp_dir.path }}/zabbix-server-values.yaml"
    mode: "0644"
  changed_when: false

- name: Record Zabbix Helm values file path
  ansible.builtin.set_fact:
    __zabbix_values_file: "{{ __temp_dir.path }}/zabbix-server-values.yaml"

- name: Flush handlers before deploying Zabbix
  ansible.builtin.meta: flush_handlers

- name: Compute Zabbix Helm timeout seconds
  ansible.builtin.set_fact:
    __zabbix_helm_timeout_seconds: >-
      {{ ((mgmt_cluster_zabbix_helm_timeout | default('600s')) ~ '')
         | regex_replace('s$', '')
         | int }}

- name: Deploy Zabbix in mgmt cluster via Helm
  kubernetes.core.helm:
    name: "{{ mgmt_cluster_zabbix_release_name | default('zabbix') }}"
    chart_ref: zabbix-community/zabbix
    kubeconfig: "{{ __temp_dir.path }}/kubeconfig-mgmt"
    release_namespace: "{{ mgmt_cluster_zabbix_namespace | default('zabbix') }}"
    create_namespace: true
    wait: true
    timeout: "{{ (__zabbix_helm_timeout_seconds | default(600)) | int }}s"
    values_files: "{{ [__zabbix_values_file] if __zabbix_values_file is defined else omit }}"
    state: present
    binary_path: "{{ helm_binary_path }}"

- name: Collect Zabbix server service endpoint candidates
  ansible.builtin.command:
    cmd: >
      kubectl --kubeconfig {{ __temp_dir.path }}/kubeconfig-mgmt
      --namespace {{ mgmt_cluster_zabbix_namespace | default('zabbix') }}
      get svc {{ mgmt_cluster_zabbix_server_service_name | default(mgmt_cluster_zabbix_release_name | default('zabbix') ~ '-zabbix-server') }}
      -o jsonpath='{.status.loadBalancer.ingress[0].ip}{"\n"}{.status.loadBalancer.ingress[0].hostname}{"\n"}{.spec.externalIPs[0]}'
  register: __zabbix_server_endpoints_cmd
  retries: "{{ mgmt_cluster_zabbix_server_lb_wait_retries | default(30) }}"
  delay: "{{ mgmt_cluster_zabbix_server_lb_wait_delay | default(10) }}"
  changed_when: false
  until: >-
    (__zabbix_server_endpoints_cmd.stdout | trim) | length > 0

- name: Gather Zabbix server endpoint candidate list
  ansible.builtin.set_fact:
    __zabbix_server_endpoint_candidates: >-
      {{
        __zabbix_server_endpoints_cmd.stdout
        | split('\n')
        | map('trim')
        | reject('equalto', '')
        | list
      }}

- name: Record Zabbix server endpoint for infra cluster proxies
  ansible.builtin.set_fact:
    __zabbix_proxy_server_host: >-
      {{
        infra_cluster_zabbix_proxy_server_host
        | default(
            __zabbix_server_endpoint_candidates | first | default(''),
            true
          )
      }}

- name: Ensure Zabbix server endpoint resolved for proxy deployment
  ansible.builtin.fail:
    msg: >-
      Unable to determine an endpoint for the Zabbix server service
      "{{ mgmt_cluster_zabbix_server_service_name | default(mgmt_cluster_zabbix_release_name | default('zabbix') ~ '-zabbix-server') }}"
      in namespace "{{ mgmt_cluster_zabbix_namespace | default('zabbix') }}".
  when: (__zabbix_proxy_server_host | default('')) | length == 0

- name: Print Zabbix server endpoint used by infra proxy
  when: ansible_verbosity | int >= 2
  ansible.builtin.debug:
    msg: "Using Zabbix server endpoint {{ __zabbix_proxy_server_host }} for infra proxy deployment"

- name: Collect Zabbix web service endpoint candidates
  ansible.builtin.command:
    cmd: >
      kubectl --kubeconfig {{ __temp_dir.path }}/kubeconfig-mgmt
      --namespace {{ mgmt_cluster_zabbix_namespace | default('zabbix') }}
      get svc {{ mgmt_cluster_zabbix_web_service_name | default(mgmt_cluster_zabbix_release_name | default('zabbix') ~ '-zabbix-web') }}
      -o jsonpath='{.status.loadBalancer.ingress[0].ip}{"\n"}{.status.loadBalancer.ingress[0].hostname}{"\n"}{.spec.externalIPs[0]}'
  register: __zabbix_web_endpoints_cmd
  retries: "{{ mgmt_cluster_zabbix_web_lb_wait_retries | default(30) }}"
  delay: "{{ mgmt_cluster_zabbix_web_lb_wait_delay | default(10) }}"
  changed_when: false
  until: >-
    (__zabbix_web_endpoints_cmd.stdout | trim) | length > 0

- name: Gather Zabbix web endpoint candidate list
  ansible.builtin.set_fact:
    __zabbix_web_endpoint_candidates: >-
      {{
        __zabbix_web_endpoints_cmd.stdout
        | split('\n')
        | map('trim')
        | reject('equalto', '')
        | list
      }}

- name: Record Zabbix web endpoint
  ansible.builtin.set_fact:
    __zabbix_web_external_host: >-
      {{
        __zabbix_web_endpoint_candidates | first | default('')
      }}
    zabbix_web_external_host: >-
      {{
        __zabbix_web_endpoint_candidates | first | default('')
      }}

- name: Ensure Zabbix web endpoint resolved
  ansible.builtin.fail:
    msg: >-
      Unable to determine an endpoint for the Zabbix web service
      "{{ mgmt_cluster_zabbix_web_service_name | default(mgmt_cluster_zabbix_release_name | default('zabbix') ~ '-zabbix-web') }}"
      in namespace "{{ mgmt_cluster_zabbix_namespace | default('zabbix') }}".
  when: (__zabbix_web_external_host | default('')) | length == 0

- name: Print Zabbix web endpoint
  when: ansible_verbosity | int >= 2
  ansible.builtin.debug:
    msg: "Discovered Zabbix web endpoint {{ __zabbix_web_external_host }}"

- name: Ensure directory for Zabbix web reverse proxy config exists
  ansible.builtin.file:
    path: "{{ zabbix_web_reverse_proxy_config_dir }}"
    state: directory
    mode: "0755"
  when: zabbix_web_reverse_proxy_enabled | bool

- name: Record Zabbix web reverse proxy config path
  ansible.builtin.set_fact:
    __zabbix_web_reverse_proxy_config_path: >-
      {{
        (zabbix_web_reverse_proxy_config_dir | regex_replace('/+$', ''))
        ~ '/zabbix-web-proxy.conf'
      }}
  when: zabbix_web_reverse_proxy_enabled | bool

- name: Render Zabbix web reverse proxy config
  ansible.builtin.template:
    src: templates/nginx/zabbix-web-proxy.conf.j2
    dest: "{{ __zabbix_web_reverse_proxy_config_path }}"
    mode: "0644"
  when: zabbix_web_reverse_proxy_enabled | bool

- name: Ensure Zabbix web reverse proxy container is running
  containers.podman.podman_container:
    name: "{{ zabbix_web_reverse_proxy_container_name }}"
    image: "{{ zabbix_web_reverse_proxy_image }}"
    state: started
    restart_policy: unless-stopped
    network: "{{ zabbix_web_reverse_proxy_network }}"
    publish:
      - "{{ zabbix_web_reverse_proxy_host_port }}:{{ zabbix_web_reverse_proxy_listen_port }}"
    volume:
      - "{{ __zabbix_web_reverse_proxy_config_path }}:/etc/nginx/conf.d/default.conf:ro"
    env:
      NGINX_ENTRYPOINT_QUIET_LOGS: "1"
    cmd_args: "{{ zabbix_web_reverse_proxy_extra_args | default([]) }}"
  when: zabbix_web_reverse_proxy_enabled | bool

- name: Record Zabbix web reverse proxy URL
  ansible.builtin.set_fact:
    zabbix_web_reverse_proxy_url: "http://127.0.0.1:{{ zabbix_web_reverse_proxy_host_port }}"
  when: zabbix_web_reverse_proxy_enabled | bool

- name: Print Zabbix web reverse proxy URL
  when:
    - zabbix_web_reverse_proxy_enabled | bool
    - ansible_verbosity | int >= 1
  ansible.builtin.debug:
    msg: "Zabbix web UI available at {{ zabbix_web_reverse_proxy_url }}"

- name: Render Zabbix proxy Helm values file
  ansible.builtin.template:
    src: templates/helm/infra/zabbix-proxy/values.yaml.j2
    dest: "{{ __temp_dir.path }}/zabbix-proxy-values.yaml"
    mode: "0644"
  register: __zabbix_proxy_values_template
  changed_when: false

- name: Record Zabbix proxy Helm values file path
  ansible.builtin.set_fact:
    __zabbix_proxy_values_file: "{{ __zabbix_proxy_values_template.dest }}"

- name: Compute Zabbix proxy Helm timeout seconds
  ansible.builtin.set_fact:
    __zabbix_proxy_helm_timeout_seconds: >-
      {{ ((infra_cluster_zabbix_proxy_helm_timeout | default('600s')) ~ '')
         | regex_replace('s$', '')
         | int }}

- name: Determine Zabbix proxy registration name
  ansible.builtin.set_fact:
    __zabbix_proxy_registration_name: >-
      {{
        infra_cluster_zabbix_proxy_registration_name
        | default(infra_cluster_zabbix_proxy_hostname, true)
      }}

- name: Deploy Zabbix proxy in infra cluster via Helm
  kubernetes.core.helm:
    name: "{{ infra_cluster_zabbix_proxy_release_name | default('zabbix-proxy') }}"
    chart_ref: zabbix-community/zabbix
    kubeconfig: "{{ __temp_dir.path }}/kubeconfig-infra"
    release_namespace: "{{ infra_cluster_zabbix_proxy_namespace | default('zabbix-proxy') }}"
    create_namespace: true
    wait: true
    timeout: "{{ (__zabbix_proxy_helm_timeout_seconds | default(600)) | int }}s"
    values_files: "{{ [__zabbix_proxy_values_file] if __zabbix_proxy_values_file is defined else omit }}"
    state: present
    binary_path: "{{ helm_binary_path }}"

- name: Determine Zabbix API network endpoint
  ansible.builtin.set_fact:
    __zabbix_api_host: >-
      {{
        (zabbix_api_host | string | trim)
        if (
          zabbix_api_host is defined
          and (zabbix_api_host | string | trim) | length > 0
          and (zabbix_api_host | string | trim) | lower not in ['none', 'null']
        )
        else (
          (zabbix_web_reverse_proxy_enabled | default(false) | bool)
          | ternary('127.0.0.1', __zabbix_web_external_host)
        )
      }}
    __zabbix_api_port: >-
      {{
        (
          zabbix_api_port | string | trim
        )
        if (
          zabbix_api_port is defined
          and (zabbix_api_port | string | trim) | length > 0
          and (zabbix_api_port | string | trim) | lower not in ['none', 'null']
        )
        else (
          (zabbix_web_reverse_proxy_enabled | default(false) | bool)
          | ternary(zabbix_web_reverse_proxy_host_port, mgmt_cluster_zabbix_web_service.port | default(80))
        )
      }}
    __zabbix_api_use_ssl: "{{ zabbix_api_use_ssl | default(false) | bool }}"
    __zabbix_api_validate_certs: "{{ (zabbix_api_validate_certs | default(zabbix_api_use_ssl | default(false))) | bool }}"
    __zabbix_api_url_path: "{{ (zabbix_api_url_path | default('')) | regex_replace('^/+', '') | regex_replace('/+$', '') }}"
    __zabbix_api_path: "{{ (zabbix_api_path | default('api_jsonrpc.php')) | regex_replace('^/+', '') }}"

- name: Ensure Zabbix API host and port resolved
  ansible.builtin.fail:
    msg: Unable to determine a reachable host for the Zabbix API endpoint.
  when: >-
    (
      (__zabbix_api_host | default('') | string | trim) | length == 0
      or (__zabbix_api_host | default('') | string | trim) | lower in ['none', 'null']
    )

- name: Normalise Zabbix API port value
  ansible.builtin.set_fact:
    __zabbix_api_port: "{{ (__zabbix_api_port | default(0)) | int }}"

- name: Ensure Zabbix API port is valid
  ansible.builtin.fail:
    msg: Unable to determine a valid port for the Zabbix API endpoint.
  when: (__zabbix_api_port | int) <= 0

- name: Determine Zabbix API scheme
  ansible.builtin.set_fact:
    __zabbix_api_scheme: "{{ 'https' if __zabbix_api_use_ssl | bool else 'http' }}"

- name: Compute Zabbix API endpoint URL
  ansible.builtin.set_fact:
    __zabbix_api_endpoint: >-
      {{
        zabbix_api_endpoint_override
        | default(
            __zabbix_api_scheme
            ~ '://'
            ~ __zabbix_api_host
            ~ ':'
            ~ (__zabbix_api_port | int | string)
            ~ '/'
            ~ __zabbix_api_url_path
            ~ '/'
            ~ __zabbix_api_path,
            true
          )
      }}

- name: Determine Zabbix API credentials
  ansible.builtin.set_fact:
    __zabbix_api_target_username: "{{ mgmt_cluster_zabbix_admin_username }}"
    __zabbix_api_target_password: "{{ mgmt_cluster_zabbix_admin_password }}"
    __zabbix_api_initial_username: "{{ mgmt_cluster_zabbix_api_initial_username | default(mgmt_cluster_zabbix_admin_username) }}"
    __zabbix_api_initial_password: "{{ mgmt_cluster_zabbix_api_initial_password | default(mgmt_cluster_zabbix_admin_password) }}"
    __zabbix_api_login_user: "{{ mgmt_cluster_zabbix_api_initial_username | default(mgmt_cluster_zabbix_admin_username) }}"
    __zabbix_api_login_password: "{{ mgmt_cluster_zabbix_api_initial_password | default(mgmt_cluster_zabbix_admin_password) }}"

- name: Determine if Zabbix admin credentials differ from initial values
  ansible.builtin.set_fact:
    __zabbix_api_should_update_credentials: >-
      {{
        (__zabbix_api_target_username | string) != (__zabbix_api_initial_username | string)
        or (__zabbix_api_target_password | string) != (__zabbix_api_initial_password | string)
      }}

- name: Validate requested Zabbix admin password
  ansible.builtin.assert:
    that:
      - (__zabbix_api_target_password | string | length) >= 8
    fail_msg: |
      Requested Zabbix admin password must be at least 8 characters long when updating credentials.
  when: __zabbix_api_should_update_credentials | bool

- name: Wait for Zabbix API availability
  ansible.builtin.uri:
    url: "{{ __zabbix_api_endpoint }}"
    method: POST
    headers:
      Content-Type: application/json-rpc
    body_format: json
    body:
      jsonrpc: "2.0"
      method: apiinfo.version
      params: []
      id: 1
    return_content: true
    status_code: 200
    validate_certs: "{{ __zabbix_api_validate_certs }}"
  register: __zabbix_api_ping
  retries: "{{ zabbix_api_wait_retries | default(60) }}"
  delay: "{{ zabbix_api_wait_delay | default(10) }}"
  until: (__zabbix_api_ping.json is defined and __zabbix_api_ping.json.result is defined)
  changed_when: false
  when: zabbix_api_wait_for_ready | default(true)

- name: Ensure desired Zabbix API user exists
  when: mgmt_cluster_zabbix_api_manage_user | bool
  vars:
    ansible_network_os: community.zabbix.zabbix
    ansible_connection: httpapi
    ansible_host: "{{ __zabbix_api_host }}"
    ansible_httpapi_port: "{{ __zabbix_api_port | int }}"
    ansible_httpapi_use_ssl: "{{ __zabbix_api_use_ssl | bool }}"
    ansible_httpapi_validate_certs: "{{ __zabbix_api_validate_certs | bool }}"
    ansible_zabbix_url_path: "{{ __zabbix_api_url_path }}"
    ansible_user: "{{ __zabbix_api_login_user }}"
    ansible_httpapi_pass: "{{ __zabbix_api_login_password }}"
  community.zabbix.zabbix_user:
    username: "{{ __zabbix_api_target_username }}"
    usrgrps: "{{ mgmt_cluster_zabbix_api_user_groups }}"
    passwd: "{{ __zabbix_api_target_password }}"
    override_passwd: "{{ __zabbix_api_should_update_credentials | bool }}"
    current_passwd: "{{ (__zabbix_api_should_update_credentials | bool and __zabbix_api_login_user == __zabbix_api_initial_username) | ternary(__zabbix_api_initial_password, omit) }}"
    role_name: "{{ mgmt_cluster_zabbix_api_role_name | default(omit) }}"
    state: present

- name: Switch Zabbix API session to managed credentials
  ansible.builtin.set_fact:
    __zabbix_api_login_user: >-
      {{
        (__zabbix_api_should_update_credentials | bool)
        | ternary(__zabbix_api_target_username, __zabbix_api_login_user)
      }}
    __zabbix_api_login_password: >-
      {{
        (__zabbix_api_should_update_credentials | bool)
        | ternary(__zabbix_api_target_password, __zabbix_api_login_password)
      }}

- name: Assemble Zabbix proxy registration payload
  ansible.builtin.set_fact:
    __zabbix_proxy_registration_payload: >-
      {{
        {
          'proxy_name': __zabbix_proxy_registration_name,
          'operating_mode': (
            infra_cluster_zabbix_proxy_registration_operating_mode
            | default(
                (
                  ((infra_cluster_zabbix_proxy_mode | default(0)) | int == 0)
                  | ternary('active', 'passive')
                ),
                true
              )
          ),
          'state': infra_cluster_zabbix_proxy_registration_state | default('present')
        }
        | combine(
            {} if infra_cluster_zabbix_proxy_registration_description in [none, '']
            else {'description': infra_cluster_zabbix_proxy_registration_description},
            recursive=True
          )
        | combine(
            infra_cluster_zabbix_proxy_registration_params | default({}),
            recursive=True
          )
      }}
  when: infra_cluster_zabbix_proxy_registration_enabled | bool

- name: Register infra proxy with Zabbix server
  when: infra_cluster_zabbix_proxy_registration_enabled | bool
  vars:
    ansible_network_os: community.zabbix.zabbix
    ansible_connection: httpapi
    ansible_host: "{{ __zabbix_api_host }}"
    ansible_httpapi_port: "{{ __zabbix_api_port | int }}"
    ansible_httpapi_use_ssl: "{{ __zabbix_api_use_ssl | bool }}"
    ansible_httpapi_validate_certs: "{{ __zabbix_api_validate_certs | bool }}"
    ansible_zabbix_url_path: "{{ __zabbix_api_url_path }}"
    ansible_user: "{{ __zabbix_api_login_user }}"
    ansible_httpapi_pass: "{{ __zabbix_api_login_password }}"
  community.zabbix.zabbix_proxy: "{{ __zabbix_proxy_registration_payload }}"

- name: Ensure proxy name available for SNMP host onboarding
  when:
    - infra_cluster_zabbix_snmp_host_registration_enabled | bool
    - (__zabbix_proxy_registration_name | default('') | string | trim) | length == 0
  ansible.builtin.fail:
    msg: Unable to determine a proxy name to attach SNMP workloads to.

- name: Initialise SNMP host registration dataset
  when: infra_cluster_zabbix_snmp_host_registration_enabled | bool
  ansible.builtin.set_fact:
    __snmpd_host_registration_objects: []

- name: Build SNMP host registration dataset
  when: infra_cluster_zabbix_snmp_host_registration_enabled | bool
  ansible.builtin.set_fact:
    __snmpd_host_registration_objects: >-
      {{
        (__snmpd_host_registration_objects | default([]))
        + [
            {
              'service_name': __snmpd_service_name,
              'service_dns': __snmpd_service_name ~ '.' ~ snmpd_namespace ~ '.svc.cluster.local.',
              'pod_name': __snmpd_pod_name,
              'namespace': snmpd_namespace
            }
          ]
      }}
  loop: "{{ range(0, snmpd_replicas | int) | list }}"
  loop_control:
    label: "{{ __snmpd_service_name }}"
  vars:
    __snmpd_service_name: "{{ snmpd_pod_service_prefix }}-{{ item }}"
    __snmpd_pod_name: "{{ snmpd_statefulset_name }}-{{ item }}"

- name: Ensure Zabbix host groups for SNMP workloads exist
  when:
    - infra_cluster_zabbix_snmp_host_registration_enabled | bool
    - (__snmpd_host_registration_objects | default([])) | length > 0
    - (infra_cluster_zabbix_snmp_host_groups | default([])) | length > 0
  vars:
    ansible_network_os: community.zabbix.zabbix
    ansible_connection: httpapi
    ansible_host: "{{ __zabbix_api_host }}"
    ansible_httpapi_port: "{{ __zabbix_api_port | int }}"
    ansible_httpapi_use_ssl: "{{ __zabbix_api_use_ssl | bool }}"
    ansible_httpapi_validate_certs: "{{ __zabbix_api_validate_certs | bool }}"
    ansible_zabbix_url_path: "{{ __zabbix_api_url_path }}"
    ansible_user: "{{ __zabbix_api_login_user }}"
    ansible_httpapi_pass: "{{ __zabbix_api_login_password }}"
  community.zabbix.zabbix_group:
    host_groups: "{{ infra_cluster_zabbix_snmp_host_groups }}"
    state: present

- name: Register SNMP workloads with Zabbix via proxy
  when:
    - infra_cluster_zabbix_snmp_host_registration_enabled | bool
    - (__snmpd_host_registration_objects | default([])) | length > 0
    - (infra_cluster_zabbix_snmp_host_groups | default([])) | length > 0
  vars:
    ansible_network_os: community.zabbix.zabbix
    ansible_connection: httpapi
    ansible_host: "{{ __zabbix_api_host }}"
    ansible_httpapi_port: "{{ __zabbix_api_port | int }}"
    ansible_httpapi_use_ssl: "{{ __zabbix_api_use_ssl | bool }}"
    ansible_httpapi_validate_certs: "{{ __zabbix_api_validate_certs | bool }}"
    ansible_zabbix_url_path: "{{ __zabbix_api_url_path }}"
    ansible_user: "{{ __zabbix_api_login_user }}"
    ansible_httpapi_pass: "{{ __zabbix_api_login_password }}"
  community.zabbix.zabbix_host:
    host_name: "{{ item.service_name }}"
    visible_name: "{{ item.pod_name }}"
    description: "SNMP simulator pod {{ item.pod_name }} in namespace {{ item.namespace }}"
    host_groups: "{{ infra_cluster_zabbix_snmp_host_groups }}"
    link_templates: "{{ infra_cluster_zabbix_snmp_templates if (infra_cluster_zabbix_snmp_templates | default([])) | length > 0 else omit }}"
    monitored_by: "{{ infra_cluster_zabbix_snmp_monitored_by }}"
    proxy: "{{ __zabbix_proxy_registration_name }}"
    status: "{{ infra_cluster_zabbix_snmp_host_status }}"
    state: present
    interfaces:
      - type: snmp
        main: 1
        useip: 0
        ip: ""
        dns: "{{ item.service_dns }}"
        port: "{{ snmpd_service_port | string }}"
        details:
          version: "{{ infra_cluster_zabbix_snmp_version | int }}"
          securityname: "{{ infra_cluster_zabbix_snmp_security_name }}"
          securitylevel: "{{ infra_cluster_zabbix_snmp_security_level | int }}"
          authprotocol: "{{ infra_cluster_zabbix_snmp_auth_protocol | int }}"
          authpassphrase: "{{ infra_cluster_zabbix_snmp_auth_passphrase }}"
          privprotocol: "{{ infra_cluster_zabbix_snmp_priv_protocol | int }}"
          privpassphrase: "{{ infra_cluster_zabbix_snmp_priv_passphrase }}"
          bulk: "{{ infra_cluster_zabbix_snmp_bulk | int }}"
    tags: "{{ (infra_cluster_zabbix_snmp_tags | default([])) + [{'tag': 'namespace', 'value': item.namespace}, {'tag': 'service', 'value': item.service_name}] }}"
    macros: "{{ infra_cluster_zabbix_snmp_macros if (infra_cluster_zabbix_snmp_macros | default([])) | length > 0 else omit }}"
  loop: "{{ __snmpd_host_registration_objects | default([]) }}"
  loop_control:
    label: "{{ item.service_name }}"
